name: Update GitHub Stats

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:  # Allows manual trigger from Actions tab
  push:
    branches:
      - master
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch GitHub Stats and Update README
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Fetch user data
            const { data: user } = await github.rest.users.getByUsername({
              username: 'mcnakhaee'
            });

            // Fetch all repos to calculate total stars
            let allRepos = [];
            let page = 1;
            while (true) {
              const { data: repos } = await github.rest.repos.listForUser({
                username: 'mcnakhaee',
                per_page: 100,
                page: page
              });
              if (repos.length === 0) break;
              allRepos = allRepos.concat(repos);
              page++;
            }

            // Calculate stats
            let totalStars = 0;
            let totalForks = 0;
            let languages = {};

            for (const repo of allRepos) {
              totalStars += repo.stargazers_count;
              totalForks += repo.forks_count;
              if (repo.language) {
                languages[repo.language] = (languages[repo.language] || 0) + 1;
              }
            }

            // Sort languages by count
            const sortedLangs = Object.entries(languages)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 5);

            // Format language badges
            const langBadges = sortedLangs.map(([lang, count]) => {
              const colors = {
                'Python': '3776AB',
                'R': '276DC3',
                'JavaScript': 'F7DF1E',
                'TypeScript': '3178C6',
                'HTML': 'E34F26',
                'CSS': '1572B6',
                'Jupyter Notebook': 'F37626',
                'Shell': '89e051',
                'Dockerfile': '2496ED'
              };
              const color = colors[lang] || '555555';
              return `![${lang}](https://img.shields.io/badge/${encodeURIComponent(lang)}-${count}%20repos-${color}?style=flat-square&logo=${encodeURIComponent(lang.toLowerCase())})`;
            }).join(' ');

            // Create stats section
            const now = new Date().toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });

            const statsSection = `
            | Stat | Count |
            |------|-------|
            | Public Repositories | **${user.public_repos}** |
            | Total Stars Earned | **${totalStars}** |
            | Total Forks | **${totalForks}** |
            | Followers | **${user.followers}** |
            | Following | **${user.following}** |

            **Top Languages:** ${langBadges}

            <sub>Last updated: ${now}</sub>`;

            // Read and update README
            let readme = fs.readFileSync('README.md', 'utf8');

            const startMarker = '<!-- GITHUB-STATS:START -->';
            const endMarker = '<!-- GITHUB-STATS:END -->';

            const regex = new RegExp(`${startMarker}[\\s\\S]*${endMarker}`, 'g');
            const newContent = `${startMarker}\n${statsSection}\n${endMarker}`;

            if (readme.includes(startMarker)) {
              readme = readme.replace(regex, newContent);
            } else {
              // If markers don't exist, append to the end
              readme += `\n\n${newContent}`;
            }

            fs.writeFileSync('README.md', readme);
            console.log('README updated successfully!');
            console.log(`Stats: ${user.public_repos} repos, ${totalStars} stars, ${totalForks} forks`);

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update GitHub stats [skip ci]" && git push)
